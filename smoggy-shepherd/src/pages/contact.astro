---
import Layout from '../layouts/Layout.astro';

const business = {
	name: 'Alex Flooring & Carpentry LLC',
	street: 'Dumfries, VA',
	locality: 'Dumfries',
	region: 'VA',
	postal: '22025',
	phone: '(703) 928-8331',
};

const mapQuery = encodeURIComponent(`${business.street}, ${business.locality}, ${business.region} ${business.postal}`);
const GOOGLE_MAPS_API_KEY = import.meta.env.PUBLIC_GOOGLE_MAPS_API_KEY || '';
const WEBHOOK_URL = 'https://example.webhook.url';
---

<Layout>
	<Fragment slot="head">
		<title>Contact | Alex Flooring & Carpentry LLC</title>
		<meta name="description" content="Contact Alex Flooring & Carpentry LLC for estimates and questions. Serving Northern Virginia." />
	</Fragment>

	<main id="main-content" class="bg-neutral">
		<section class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-10 sm:py-12 md:py-16">
			<nav aria-label="Breadcrumb" class="text-sm text-primary/80">
				<a href="/" class="hover:underline focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-accent">Home</a>
				<span aria-hidden="true" class="mx-2">/</span>
				<span aria-current="page" class="font-medium">Contact</span>
			</nav>

			<div class="mt-6 grid grid-cols-1 gap-10 lg:grid-cols-5 lg:gap-12">
				<div class="lg:col-span-2">
					<h1 class="text-3xl sm:text-4xl md:text-5xl font-extrabold tracking-tight text-primary">Contact Us</h1>
					<p class="mt-3 text-primary/80">We're here to help. Request a free estimate or ask a questionâ€”we'll get back within one business day.</p>

					<div class="mt-8 rounded-lg border border-primary/10 bg-neutral shadow-sm p-6">
						<h2 class="text-xl font-bold text-primary">Business Information</h2>
						<div class="mt-2 h-0.5 w-12 bg-accent"></div>
						<address class="not-italic mt-4 text-primary/90">
							<p class="font-semibold">{business.name}</p>
							<p>{business.locality}, {business.region} {business.postal}</p>
							<p class="mt-2">
								<a href={`tel:${business.phone.replace(/[^\d]/g, '')}`} class="underline underline-offset-4 decoration-accent hover:opacity-90 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-accent">{business.phone}</a>
							</p>
						</address>

						<div class="mt-6 aspect-video w-full overflow-hidden rounded-md border border-primary/10">
							<iframe
								title="Service Area Map"
								loading="lazy"
								referrerpolicy="no-referrer-when-downgrade"
								class="h-full w-full"
								src={`https://www.google.com/maps?q=${mapQuery}&output=embed`}
							></iframe>
						</div>
						<p class="mt-3 text-sm text-primary/70">Serving Northern Virginia: Prince William, Fairfax, Stafford, Loudoun, and nearby areas.</p>
					</div>
				</div>

				<div class="lg:col-span-3">
					<div id="form-banner" class="hidden mb-6 rounded-md p-4 text-sm" role="status" aria-live="polite"></div>

					<form id="contact-form" novalidate class="rounded-lg border border-primary/10 bg-neutral shadow-sm p-6 grid grid-cols-1 gap-6" data-webhook-url={WEBHOOK_URL} data-google-key={GOOGLE_MAPS_API_KEY}>
						<!-- Name -->
						<div>
							<label for="name" class="block text-sm font-medium text-primary">Name<span class="text-red-600"> *</span></label>
							<input id="name" name="name" type="text" autocomplete="name" required class="mt-2 block w-full rounded-md border border-primary/20 px-3 py-2 text-primary placeholder-primary/40 focus:border-accent focus:ring-2 focus:ring-accent" placeholder="John Doe" />
							<p id="error-name" class="mt-1 text-sm text-red-600 hidden"></p>
						</div>

						<!-- Phone -->
						<div>
							<label for="phone" class="block text-sm font-medium text-primary">Phone<span class="text-red-600"> *</span></label>
							<input id="phone" name="phone" inputmode="tel" autocomplete="tel" required class="mt-2 block w-full rounded-md border border-primary/20 px-3 py-2 text-primary placeholder-primary/40 focus:border-accent focus:ring-2 focus:ring-accent" placeholder="(703) 555-1234" />
							<p id="error-phone" class="mt-1 text-sm text-red-600 hidden"></p>
						</div>

						<!-- Email -->
						<div>
							<label for="email" class="block text-sm font-medium text-primary">Email<span class="text-red-600"> *</span></label>
							<input id="email" name="email" type="email" inputmode="email" autocomplete="email" required class="mt-2 block w-full rounded-md border border-primary/20 px-3 py-2 text-primary placeholder-primary/40 focus:border-accent focus:ring-2 focus:ring-accent" placeholder="john@example.com" />
							<p id="error-email" class="mt-1 text-sm text-red-600 hidden"></p>
						</div>

						<!-- Job Site Address (Google Places) -->
						<div>
							<label for="job-site-address" class="block text-sm font-medium text-primary">Job Site Address<span class="text-red-600"> *</span></label>
							<input id="job-site-address" name="job_site_address" type="text" autocomplete="street-address" required class="mt-2 block w-full rounded-md border border-primary/20 px-3 py-2 text-primary placeholder-primary/40 focus:border-accent focus:ring-2 focus:ring-accent" placeholder="Start typing address..." />
							<input id="job-site-address-place-id" type="hidden" />
							<input id="job-site-address-formatted" type="hidden" />
							<p class="mt-1 text-xs text-primary/60">Autocomplete is restricted to U.S. addresses. Please select a suggestion.</p>
							<p id="error-job-site-address" class="mt-1 text-sm text-red-600 hidden"></p>
						</div>

						<!-- Preferred Date -->
						<div>
							<label for="preferred-date" class="block text-sm font-medium text-primary">Preferred Date<span class="text-red-600"> *</span></label>
							<input id="preferred-date" name="preferred_date" type="date" autocomplete="off" required class="mt-2 block w-full rounded-md border border-primary/20 px-3 py-2 text-primary placeholder-primary/40 focus:border-accent focus:ring-2 focus:ring-accent" />
							<p id="error-preferred-date" class="mt-1 text-sm text-red-600 hidden"></p>
						</div>

						<!-- Preferred Time -->
						<div>
							<label for="preferred-time" class="block text-sm font-medium text-primary">Preferred Time<span class="text-red-600"> *</span></label>
							<select id="preferred-time" name="preferred_time" autocomplete="off" required class="mt-2 block w-full rounded-md border border-primary/20 px-3 py-2 text-primary focus:border-accent focus:ring-2 focus:ring-accent">
								<option value="">Select a time</option>
							</select>
							<p id="error-preferred-time" class="mt-1 text-sm text-red-600 hidden"></p>
						</div>

						<!-- Customer Type -->
						<fieldset class="mt-2">
							<legend class="block text-sm font-medium text-primary">Customer Type<span class="text-red-600"> *</span></legend>
							<div class="mt-2 flex flex-col sm:flex-row gap-4">
								<label class="inline-flex items-center gap-2 text-primary">
									<input type="radio" name="customer_type" value="new" autocomplete="off" class="h-4 w-4 text-primary focus:ring-accent" />
									<span>New customer</span>
								</label>
								<label class="inline-flex items-center gap-2 text-primary">
									<input type="radio" name="customer_type" value="returning" autocomplete="off" class="h-4 w-4 text-primary focus:ring-accent" />
									<span>Returning customer</span>
								</label>
							</div>
							<p id="error-customer-type" class="mt-1 text-sm text-red-600 hidden"></p>
						</fieldset>

						<!-- Message -->
						<div>
							<label for="message" class="block text-sm font-medium text-primary">Message<span class="text-red-600"> *</span></label>
							<textarea id="message" name="message" rows="5" autocomplete="off" required class="mt-2 block w-full rounded-md border border-primary/20 px-3 py-2 text-primary placeholder-primary/40 focus:border-accent focus:ring-2 focus:ring-accent" placeholder="Tell us about your project..." ></textarea>
							<p id="error-message" class="mt-1 text-sm text-red-600 hidden"></p>
						</div>

						<div class="flex items-center justify-between gap-4">
							<p class="text-sm text-primary/70"><span class="text-red-600">*</span> Required fields</p>
							<button id="submit-btn" type="submit" class="inline-flex items-center justify-center rounded-md bg-primary text-neutral px-6 py-3 text-base font-semibold shadow-sm hover:bg-primary/90 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-accent disabled:opacity-60 disabled:cursor-not-allowed">Send Message</button>
						</div>
					</form>
				</div>
			</div>
		</section>
	</main>

	<script is:inline>
		function qs(id) {
			const el = document.getElementById(id);
			if (!el) throw new Error(`Missing element: ${id}`);
			return el;
		}

		/** @type {HTMLFormElement} */
		const form = /** @type {any} */(qs('contact-form'));
		/** @type {HTMLDivElement} */
		const banner = /** @type {any} */(qs('form-banner'));
		/** @type {HTMLButtonElement} */
		const submitBtn = /** @type {any} */(qs('submit-btn'));

		/** @type {HTMLInputElement} */
		const nameInput = /** @type {any} */(qs('name'));
		/** @type {HTMLInputElement} */
		const phoneInput = /** @type {any} */(qs('phone'));
		/** @type {HTMLInputElement} */
		const emailInput = /** @type {any} */(qs('email'));
		/** @type {HTMLInputElement} */
		const addrInput = /** @type {any} */(qs('job-site-address'));
		/** @type {HTMLInputElement} */
		const addrPlaceId = /** @type {any} */(qs('job-site-address-place-id'));
		/** @type {HTMLInputElement} */
		const addrFormatted = /** @type {any} */(qs('job-site-address-formatted'));
		/** @type {HTMLInputElement} */
		const dateInput = /** @type {any} */(qs('preferred-date'));
		/** @type {HTMLSelectElement} */
		const timeSelect = /** @type {any} */(qs('preferred-time'));

		/** @type {HTMLParagraphElement} */
		const errorName = /** @type {any} */(qs('error-name'));
		/** @type {HTMLParagraphElement} */
		const errorPhone = /** @type {any} */(qs('error-phone'));
		/** @type {HTMLParagraphElement} */
		const errorEmail = /** @type {any} */(qs('error-email'));
		/** @type {HTMLParagraphElement} */
		const errorAddress = /** @type {any} */(qs('error-job-site-address'));
		/** @type {HTMLParagraphElement} */
		const errorDate = /** @type {any} */(qs('error-preferred-date'));
		/** @type {HTMLParagraphElement} */
		const errorTime = /** @type {any} */(qs('error-preferred-time'));
		/** @type {HTMLParagraphElement} */
		const errorCustomerType = /** @type {any} */(qs('error-customer-type'));
		/** @type {HTMLParagraphElement} */
		const errorMessage = /** @type {any} */(qs('error-message'));

		const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i;

		function formatPhone(value) {
			const digits = value.replace(/\D/g, '').slice(0, 10);
			const len = digits.length;
			if (len === 0) return '';
			if (len < 4) return `(${digits}`;
			if (len < 7) return `(${digits.slice(0,3)}) ${digits.slice(3)}`;
			return `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6,10)}`;
		}

		phoneInput.addEventListener('input', () => {
			const cursorFromEnd = phoneInput.value.length - (phoneInput.selectionStart ?? phoneInput.value.length);
			phoneInput.value = formatPhone(phoneInput.value);
			const newPos = phoneInput.value.length - Math.max(0, cursorFromEnd);
			phoneInput.setSelectionRange(newPos, newPos);
		});

		function setError(el, errEl, message) {
			if (message) {
				el.setAttribute('aria-invalid', 'true');
				errEl.textContent = message;
				errEl.classList.remove('hidden');
				el.classList.remove('border-primary/20');
				el.classList.add('border-red-600');
			} else {
				el.removeAttribute('aria-invalid');
				errEl.textContent = '';
				errEl.classList.add('hidden');
				el.classList.remove('border-red-600');
				el.classList.add('border-primary/20');
			}
		}

		function setGroupError(errEl, message) {
			if (message) {
				errEl.textContent = message;
				errEl.classList.remove('hidden');
			} else {
				errEl.textContent = '';
				errEl.classList.add('hidden');
			}
		}

		function yyyyMmDdUtc(date) {
			const y = date.getUTCFullYear();
			const m = String(date.getUTCMonth() + 1).padStart(2, '0');
			const d = String(date.getUTCDate()).padStart(2, '0');
			return `${y}-${m}-${d}`;
		}

		function addDaysStr(yyyyMmDdStr, days) {
			const [y, m, d] = yyyyMmDdStr.split('-').map(Number);
			const dt = new Date(Date.UTC(y, (m || 1) - 1, d || 1));
			dt.setUTCDate(dt.getUTCDate() + days);
			return yyyyMmDdUtc(dt);
		}

		// Date constraints: today .. today+60 (America/Chicago)
		const chicagoTodayStr = new Intl.DateTimeFormat('en-CA', {
			timeZone: 'America/Chicago', year: 'numeric', month: '2-digit', day: '2-digit'
		}).format(new Date());
		dateInput.min = chicagoTodayStr;
		dateInput.max = addDaysStr(chicagoTodayStr, 60);

		// Time options: 07:00 to 18:00, 15-min increments
		function formatTimeLabel(h, m) {
			const ampm = h >= 12 ? 'PM' : 'AM';
			const hour12 = ((h + 11) % 12) + 1;
			return `${hour12}:${String(m).padStart(2, '0')} ${ampm}`;
		}
		for (let h = 7; h <= 18; h++) {
			for (let m = 0; m < 60; m += 15) {
				if (h === 18 && m > 0) break; // do not go past 18:00
				const value = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
				const opt = document.createElement('option');
				opt.value = value;
				opt.textContent = formatTimeLabel(h, m);
				timeSelect.appendChild(opt);
			}
		}

		// Google Places Autocomplete (US only), requires API key
		const GOOGLE_KEY = form.getAttribute('data-google-key') || '';
		let autocompleteReady = false;
		window.initAddressAutocomplete = function initAddressAutocomplete() {
			try {
				// @ts-ignore
				const autocomplete = new google.maps.places.Autocomplete(addrInput, {
					componentRestrictions: { country: 'us' },
					fields: ['formatted_address', 'place_id'],
					types: ['address'],
				});
				autocomplete.addListener('place_changed', () => {
					// @ts-ignore
					const place = autocomplete.getPlace();
					addrPlaceId.value = place?.place_id || '';
					addrFormatted.value = place?.formatted_address || '';
					addrInput.dataset.selected = place?.place_id ? 'true' : 'false';
				});
				autocompleteReady = true;
			} catch (e) {
				autocompleteReady = false;
			}
		};
		if (GOOGLE_KEY) {
			const s = document.createElement('script');
			s.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(GOOGLE_KEY)}&libraries=places&callback=initAddressAutocomplete`;
			s.async = true;
			s.defer = true;
			document.head.appendChild(s);
		}

		// Validation
		function validate() {
			let valid = true;
			// Name
			if (!nameInput.value.trim()) { setError(nameInput, errorName, 'Name is required.'); valid = false; } else { setError(nameInput, errorName, ''); }
			// Phone
			const phoneValue = phoneInput.value.trim();
			if (!phoneValue) { setError(phoneInput, errorPhone, 'Phone is required.'); valid = false; }
			else if (!/^\(\d{3}\) \d{3}-\d{4}$/.test(phoneValue)) { setError(phoneInput, errorPhone, 'Use format (###) ###-####.'); valid = false; }
			else { setError(phoneInput, errorPhone, ''); }
			// Email
			const emailValue = emailInput.value.trim();
			if (!emailValue) { setError(emailInput, errorEmail, 'Email is required.'); valid = false; }
			else if (!emailRegex.test(emailValue)) { setError(emailInput, errorEmail, 'Enter a valid email address.'); valid = false; }
			else { setError(emailInput, errorEmail, ''); }
			// Address (must select suggestion)
			if (!GOOGLE_KEY) {
				setError(addrInput, errorAddress, 'Address autocomplete not configured.');
				valid = false;
			} else if (!addrPlaceId.value || addrInput.dataset.selected !== 'true') {
				setError(addrInput, errorAddress, 'Please select an address from suggestions.');
				valid = false;
			} else { setError(addrInput, errorAddress, ''); }
			// Date
			if (!dateInput.value) { setError(dateInput, errorDate, 'Preferred date is required.'); valid = false; }
			else if (dateInput.value < dateInput.min || dateInput.value > dateInput.max) { setError(dateInput, errorDate, 'Choose a date between today and 60 days from now.'); valid = false; }
			else { setError(dateInput, errorDate, ''); }
			// Time
			if (!timeSelect.value) { setError(timeSelect, errorTime, 'Preferred time is required.'); valid = false; }
			else { setError(timeSelect, errorTime, ''); }
			// Customer type
			const customerChecked = document.querySelector('input[name="customer_type"]:checked');
			if (!customerChecked) { setGroupError(errorCustomerType, 'Please select customer type.'); valid = false; }
			else { setGroupError(errorCustomerType, ''); }
			// Message
			const msg = /** @type {HTMLTextAreaElement} */(qs('message')).value.trim();
			if (!msg) { setError(qs('message'), errorMessage, 'Message is required.'); valid = false; }
			else if (msg.length < 10) { setError(qs('message'), errorMessage, 'Message must be at least 10 characters.'); valid = false; }
			else { setError(qs('message'), errorMessage, ''); }
			return valid;
		}

		[nameInput, phoneInput, emailInput, addrInput, dateInput, timeSelect, /** @type {any} */(qs('message'))].forEach((el) => {
			el.addEventListener('input', validate);
			el.addEventListener('change', validate);
			el.addEventListener('blur', validate);
		});
		Array.from(document.querySelectorAll('input[name="customer_type"]')).forEach((el) => {
			el.addEventListener('input', validate);
			el.addEventListener('change', validate);
			el.addEventListener('blur', validate);
		});



		form.addEventListener('submit', async (e) => {
			e.preventDefault();
			banner.className = 'hidden mb-6 rounded-md p-4 text-sm';
			if (!validate()) return;
			submitBtn.disabled = true;
			submitBtn.textContent = 'Sending...';

			const payload = {
				name: nameInput.value.trim(),
				phone: phoneInput.value.trim(),
				email: emailInput.value.trim(),
				job_site_address: {
					formatted_address: addrFormatted.value || '',
					place_id: addrPlaceId.value || '',
				},
				preferred_date: dateInput.value,
				preferred_time: timeSelect.value,
				customer_type: /** @type {HTMLInputElement|null} */(document.querySelector('input[name="customer_type"]:checked'))?.value || '',
				message: /** @type {HTMLTextAreaElement} */(qs('message')).value.trim(),
			};

			console.log('Contact form payload:', payload);
			try {
				const res = await fetch(form.getAttribute('data-webhook-url') || '', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(payload),
				});
				if (res.ok) {
					banner.textContent = 'Thank you, your request has been received.';
					banner.className = 'mb-6 rounded-md p-4 text-sm bg-green-50 text-green-800 border border-green-200';
					form.reset();
					addrPlaceId.value = '';
					addrFormatted.value = '';
					addrInput.dataset.selected = 'false';
				} else {
					banner.textContent = 'Something went wrong. Please try again later.';
					banner.className = 'mb-6 rounded-md p-4 text-sm bg-red-50 text-red-700 border border-red-200';
				}
			} catch (err) {
				banner.textContent = 'Something went wrong. Please try again later.';
				banner.className = 'mb-6 rounded-md p-4 text-sm bg-red-50 text-red-700 border border-red-200';
			} finally {
				submitBtn.disabled = false;
				submitBtn.textContent = 'Send Message';
			}
		});
	</script>

</Layout>


